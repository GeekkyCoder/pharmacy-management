import{a3 as I,W as ua,V as ha,U as ma,N as pa,b as D,ao as g,a6 as M,ac as Q,aa as J,ap as $,ai as X,O as a,$ as Y,a5 as oa,a7 as da,aj as ra,Z as x,H as E,y as P,ae as k,al as V,a8 as A,aq as _a}from"./index-CZBkQvc6.js";import{S as aa,R as ga}from"./index-BLa8Ka6_.js";const Pa=async(p,_,h)=>{var o,l,u;try{const m=await I.post("/purchase/newPurchase",p),{data:C}=m.data;return C&&_({data:C,message:(o=m==null?void 0:m.data)==null?void 0:o.message}),!0}catch(m){return h(((u=(l=m==null?void 0:m.response)==null?void 0:l.data)==null?void 0:u.message)||(m==null?void 0:m.message)||"Failed to create purchase"),!1}},ya=async(p,_,h)=>{var o,l;try{const u=await I.post("/discount/calculate-cart",{items:p}),{data:m}=u.data;return m&&_(m),!0}catch(u){return h(((l=(o=u==null?void 0:u.response)==null?void 0:o.data)==null?void 0:l.message)||(u==null?void 0:u.message)||"Failed to calculate discount"),!1}},ja=async(p,_)=>{var h,o;try{const l=await I.get("/medicine/getMedicines"),{data:u}=l.data;return u&&p(u),!0}catch(l){return _(((o=(h=l==null?void 0:l.response)==null?void 0:h.data)==null?void 0:o.message)||(l==null?void 0:l.message)||"Failed to get medicines"),!1}},{Title:xa}=ma,{Step:fa}=aa,Da=p=>{const _=pa(s=>{var c;return(c=s==null?void 0:s.auth)==null?void 0:c.user}),[h,o]=D.useState(0),[l,u]=D.useState(null),[m,C]=D.useState([]),[ea,w]=D.useState(!1),sa={Sup_Name:"",Sup_Phno:"",purchases:[{P_Name:"",P_Qty:1,P_Cost:0,Mfg_Date:g(),Exp_Date:g(),Pur_Date:g()}]},ta=[M().shape({Sup_Name:Q().required("Name is required").matches(/^[A-Za-z ]+$/,"Name can contain only letters"),Sup_Phno:Q().required("Phone is required").test("phone-number-check","should start with 03",s=>s==null?void 0:s.startsWith("03")).length(11,"Phone number should be 11 digits")}),M().shape({purchases:J().of(M().shape({P_Name:Q().required("Medicine Name is required"),P_Qty:X().positive().required("Quantity is required"),P_Cost:X().positive().required("Cost is required"),Mfg_Date:$().required("Mfg Date is required"),Exp_Date:$().required("Exp Date is required"),Pur_Date:$().required("Purchase Date is required")}))}),M().shape({purchases:J().min(1,"At least one purchase is required")})];D.useEffect(()=>{(async()=>{await ja(c=>C(c),c=>p.error(c))})()},[]);const R=async s=>{w(!0);const c=s.map(e=>{const t=m.find(i=>i.Med_Name.toLowerCase()===e.P_Name.toLowerCase());return{medicineId:(t==null?void 0:t._id)||e.P_Name,quantity:e.P_Qty||1}});await ya(c,e=>{u(e),w(!1)},e=>{p.error(e),w(!1);const t={items:s.map(i=>({medicine:{name:i.P_Name,price:i.P_Cost},quantity:i.P_Qty,originalAmount:i.P_Cost*i.P_Qty,discountApplied:null,finalAmount:i.P_Cost*i.P_Qty})),summary:{totalOriginalAmount:s.reduce((i,n)=>i+n.P_Cost*n.P_Qty,0),totalDiscountAmount:0,totalFinalAmount:s.reduce((i,n)=>i+n.P_Cost*n.P_Qty,0),totalSavings:0}};u(t)})},na=async(s,c)=>{p.setLoading(!0);const e={...s,purchaseMadeBy:_==null?void 0:_._id,discountInfo:(l==null?void 0:l.summary)||null};await Pa(e,ia,ca)&&(c(),o(0),u(null)),p.setLoading(!1)},ia=s=>p.success(s==null?void 0:s.message),ca=s=>p.error(s),N=[{title:"Supplier Details",content:({values:s,setFieldValue:c,errors:e,touched:t})=>a.jsxs(E,{gutter:16,children:[a.jsxs(P,{span:12,children:[a.jsx("label",{children:"Name"}),a.jsx(k,{value:s.Sup_Name,onChange:i=>c("Sup_Name",i.target.value)}),(t==null?void 0:t.Sup_Name)&&(e==null?void 0:e.Sup_Name)&&a.jsx("div",{className:"error",children:e==null?void 0:e.Sup_Name})]}),a.jsxs(P,{span:12,children:[a.jsx("label",{children:"Phone"}),a.jsx(k,{value:s.Sup_Phno,onChange:i=>c("Sup_Phno",i.target.value)}),(t==null?void 0:t.Sup_Phno)&&(e==null?void 0:e.Sup_Phno)&&a.jsx("div",{className:"error",children:e==null?void 0:e.Sup_Phno})]})]})},{title:"Purchase Details",content:({values:s,setFieldValue:c,errors:e,touched:t})=>a.jsxs(a.Fragment,{children:[s.purchases.map((i,n)=>{var S,y,r,j,f,q,b,v,T,B,L,O,W,F,Z,z,H,K,U,G;return a.jsxs(Y,{className:"medicine-card",style:{marginBottom:16},title:`Medicine #${n+1}`,extra:s.purchases.length>1&&a.jsx(x,{type:"text",danger:!0,icon:a.jsx(ga,{}),onClick:()=>{const d=s.purchases.filter((Ca,la)=>la!==n);c("purchases",d)},children:"Remove"}),children:[a.jsxs(E,{gutter:16,children:[a.jsxs(P,{span:8,children:[a.jsx("label",{children:"Medicine Name"}),a.jsx(k,{value:i.P_Name,onChange:d=>c(`purchases[${n}].P_Name`,d.target.value)}),((y=(S=t==null?void 0:t.purchases)==null?void 0:S[n])==null?void 0:y.P_Name)&&((j=(r=e==null?void 0:e.purchases)==null?void 0:r[n])==null?void 0:j.P_Name)&&a.jsx("div",{className:"error",children:e.purchases[n].P_Name})]}),a.jsxs(P,{span:4,children:[a.jsx("label",{children:"Quantity"}),a.jsx(V,{min:1,style:{width:"100%"},value:i.P_Qty,onChange:d=>c(`purchases[${n}].P_Qty`,d)}),((q=(f=t==null?void 0:t.purchases)==null?void 0:f[n])==null?void 0:q.P_Qty)&&((v=(b=e==null?void 0:e.purchases)==null?void 0:b[n])==null?void 0:v.P_Qty)&&a.jsx("div",{className:"error",children:e.purchases[n].P_Qty})]}),a.jsxs(P,{span:4,children:[a.jsx("label",{children:"Cost (per unit)"}),a.jsx(V,{min:0,style:{width:"100%"},value:i.P_Cost,onChange:d=>c(`purchases[${n}].P_Cost`,d)}),((B=(T=t==null?void 0:t.purchases)==null?void 0:T[n])==null?void 0:B.P_Cost)&&((O=(L=e==null?void 0:e.purchases)==null?void 0:L[n])==null?void 0:O.P_Cost)&&a.jsx("div",{className:"error",children:e.purchases[n].P_Cost})]}),a.jsxs(P,{span:8,children:[a.jsx("label",{children:"Purchase Date"}),a.jsx(A,{disabled:!0,style:{width:"100%"},value:g(i.Pur_Date),onChange:d=>c(`purchases[${n}].Pur_Date`,d)})]})]}),a.jsxs(E,{gutter:16,style:{marginTop:16},children:[a.jsxs(P,{span:8,children:[a.jsx("label",{children:"Mfg Date"}),a.jsx(A,{style:{width:"100%"},value:g(i.Mfg_Date),onChange:d=>c(`purchases[${n}].Mfg_Date`,d)}),((F=(W=t==null?void 0:t.purchases)==null?void 0:W[n])==null?void 0:F.Mfg_Date)&&((z=(Z=e==null?void 0:e.purchases)==null?void 0:Z[n])==null?void 0:z.Mfg_Date)&&a.jsx("div",{className:"error",children:e.purchases[n].Mfg_Date})]}),a.jsxs(P,{span:8,children:[a.jsx("label",{children:"Exp Date"}),a.jsx(A,{style:{width:"100%"},value:g(i.Exp_Date),onChange:d=>c(`purchases[${n}].Exp_Date`,d)}),((K=(H=t==null?void 0:t.purchases)==null?void 0:H[n])==null?void 0:K.Exp_Date)&&((G=(U=e==null?void 0:e.purchases)==null?void 0:U[n])==null?void 0:G.Exp_Date)&&a.jsx("div",{className:"error",children:e.purchases[n].Exp_Date})]}),a.jsx(P,{span:8,children:a.jsx("div",{style:{marginTop:16},children:a.jsxs("strong",{children:["Total: PKR ",((i.P_Qty||0)*(i.P_Cost||0)).toFixed(2)]})})})]})]},n)}),a.jsx(x,{type:"dashed",block:!0,icon:a.jsx(_a,{}),onClick:()=>{const i={P_Name:"",P_Qty:1,P_Cost:0,Mfg_Date:g(),Exp_Date:g(),Pur_Date:g()};c("purchases",[...s.purchases,i])},style:{marginTop:16},children:"Add Another Medicine"})]})}];return a.jsxs(Y,{children:[a.jsx(xa,{level:3,children:"Supplier & Purchase Entry"}),a.jsx(oa,{initialValues:sa,validationSchema:ta[h],validateOnChange:!0,validateOnBlur:!0,onSubmit:async(s,{resetForm:c})=>{h<N.length-1?o(h+1):await na(s,c)},children:({values:s,setFieldValue:c,errors:e,touched:t,validateForm:i,handleSubmit:n,setTouched:S})=>a.jsxs(da,{children:[a.jsx(aa,{current:h,style:{marginBottom:32},children:N.map((y,r)=>a.jsx(fa,{title:y.title},r))}),a.jsx("div",{children:N[h].content({values:s,setFieldValue:c,errors:e,touched:t})}),a.jsx(ra,{}),a.jsxs("div",{className:"step-navigation",style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[h>0&&a.jsx(x,{onClick:()=>o(h-1),children:"Back"}),h===2&&l&&a.jsx(x,{onClick:()=>R(s.purchases),loading:ea,style:{marginLeft:"auto",marginRight:8},children:"Recalculate Discounts"}),h<N.length-1?a.jsx(x,{type:"primary",onClick:()=>{i().then(y=>{if(Object.keys(y).length===0){const r=h+1;o(r),r===2&&R(s.purchases)}else{const r={};Object.keys(y).forEach(j=>{if(j.includes("purchases")){const f=j.match(/purchases\[(\d+)\]\.(\w+)/);if(f){const[q,b,v]=f;r[`purchases.${b}.${v}`]=!0}}else r[j]=!0}),S(r)}})},children:"Next"}):a.jsx(x,{type:"primary",htmlType:"submit",loading:p.loading,children:"Submit Purchase"})]})]})})]})},ba=ua(ha(Da));export{ba as default};
